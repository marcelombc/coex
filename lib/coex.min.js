!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("coex",[],t):"object"==typeof exports?exports.coex=t():e.coex=t()}(this,function(){return function(e){function t(i){if(a[i])return a[i].exports;var n=a[i]={exports:{},id:i,loaded:!1};return e[i].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var a={};return t.m=e,t.c=a,t.p="",t(0)}([function(e,t,a){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,a,i){return a&&e(t.prototype,a),i&&e(t,i),t}}(),s=a(1),o=i(s),h=function(){function e(t,a){n(this,e),e._count+=1,e._nextIdCount+=1,e._nextIdCount===1/0&&(e._nextIdCount=0),this._handleImageLoad=this._handleImageLoad.bind(this),this._handleImageAbort=this._handleImageAbort.bind(this),this._handleImageError=this._handleImageError.bind(this),this._workerMessageHandler=this._workerMessageHandler.bind(this),this._workerErrorHandler=this._workerErrorHandler.bind(this),this._url=t,this._maxPaletteColors=a?a:8,this._vBoxes=[],this._instanceId="coex_instance_"+e._nextIdCount,this._createDummyCanvas()}return r(e,[{key:"destroy",value:function(){for(var t=this._vBoxes.length,a=0;a<t;a+=1)this._vBoxes[a].destroy();this._vBoxes=null,e._worker&&(e._worker.removeEventListener("message",this._workerMessageHandler),e._worker.removeEventListener("error",this._workerErrorHandler),e._count-=1,0===e._count&&(e._worker.terminate(),e._worker=null)),this._destroyDummyCanvas(),this._removeImageListeners(),this._image=null,this._url=null,this._maxPaletteColors=null,this._callback=null,this._imageData=null}},{key:"get",value:function(e){this._callback=e,this._image=new Image,this._loadImage()}},{key:"getContrastColor",value:function(e,t){var a=e.length,i=t?0:1,n=0,r=0,s=void 0,o=void 0;for(t=t||e[0];i<a;i+=1)s=this._getContrast(t,e[i]),s[0]>n&&s[1]>r&&(o=e[i],n=s[0],r=s[1]);return o}},{key:"getImageBase64",value:function(){return this._canvas.toDataURL()}},{key:"_loadImage",value:function(){this._image.crossOrigin="Anonymous",this._image.addEventListener("load",this._handleImageLoad),this._image.addEventListener("abort",this._handleImageAbort),this._image.addEventListener("error",this._handleImageError),this._image.src=this._url}},{key:"_removeImageListeners",value:function(){this._image.removeEventListener("load",this._handleImageLoad),this._image.removeEventListener("abort",this._handleImageAbort),this._image.removeEventListener("error",this._handleImageError)}},{key:"_workerFallback",value:function(){var e=this._imageDataToRgbData(this._imageData);this._vBoxes.push(new o.default(e));var t=this._getPalette(this._maxPaletteColors);this._callback(null,t)}},{key:"_getPalette",value:function(e){var t=[],a=[],i=void 0,n=void 0,r=void 0,s=void 0,h=void 0,_=void 0;for(i=0;i<e;i+=1){for(r=this._vBoxes.shift(),s=r.split(),h=0,_=s.length;h<_;h+=1)this._vBoxes.push(new o.default(s[h]));r.destroy()}for(this._vBoxes.sort(function(e,t){return t.size()-e.size()}),i=0,n=this._vBoxes.length;i<n;i+=1)t.push(this._vBoxes[i].average());for(i=0;i<e;i+=1)a.push({red:t[i][0],green:t[i][1],blue:t[i][2]});return a}},{key:"_imageDataToRgbData",value:function(e){var t=[],a=void 0,i=void 0,n=void 0;for(i=0,n=e.length;i<n;i+=4)a=[e[i],e[i+1],e[i+2]],t.push(a);return t}},{key:"_getContrast",value:function(e,t){var a=(299*e.red+587*e.green+114*e.blue)/1e3,i=(299*t.red+587*t.green+114*t.blue)/1e3,n=Math.round(Math.abs(i-a)),r=Math.abs(t.red-e.red)+Math.abs(t.green-e.green)+Math.abs(t.blue-e.blue);return[n,r]}},{key:"_createDummyCanvas",value:function(){this._destroyDummyCanvas(),this._canvas=document.createElement("canvas"),this._context=this._canvas.getContext("2d"),this._context.width=1e3,this._context.height=1e3,this._context.clearRect(0,0,1e3,1e3)}},{key:"_destroyDummyCanvas",value:function(){this._context&&this._context.clearRect(0,0,1e3,1e3),this._canvas=null,this._context=null}},{key:"_handleImageLoad",value:function(){var t=this._canvas.width=this._context.width=this._image.width,a=this._canvas.height=this._context.height=this._image.height;this._removeImageListeners(),this._context.drawImage(this._image,0,0),this._imageData=this._context.getImageData(0,0,t,a).data,e.workerUrl&&"undefined"!=typeof Worker?(e._worker||(e._worker=new Worker(e.workerUrl)),e._worker.addEventListener("message",this._workerMessageHandler),e._worker.addEventListener("error",this._workerErrorHandler),e._worker.postMessage({instanceId:this._instanceId,imageData:this._imageData,maxPaletteColors:this._maxPaletteColors})):this._workerFallback()}},{key:"_handleImageAbort",value:function(){this._removeImageListeners(),this._callback(new Error("Image loading was aborted."))}},{key:"_handleImageError",value:function(){this._removeImageListeners(),this._callback(new Error("An error occurs when loading image."))}},{key:"_workerMessageHandler",value:function(t){this._instanceId===t.data.instanceId&&(t.stopImmediatePropagation(),e._worker.removeEventListener("message",this._workerMessageHandler),e._worker.removeEventListener("error",this._workerErrorHandler),this._callback(null,t.data.palette))}},{key:"_workerErrorHandler",value:function(){e._worker.removeEventListener("message",this._workerMessageHandler),e._worker.removeEventListener("error",this._workerErrorHandler),this._workerFallback()}}]),e}();h.workerUrl=null,h._worker=null,h._count=0,h._nextIdCount=0,t.default=h,e.exports=t.default},function(e,t){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,a,i){return a&&e(t.prototype,a),i&&e(t,i),t}}(),n=function(){function e(t){a(this,e),this._data=t,this._dataLength=t.length,this._calculateMinMaxAxis()}return i(e,[{key:"destroy",value:function(){this._data=null,this._dataLength=null,this._axisMinMax=null}},{key:"split",value:function(){var e=this._getLargestAxis();this._data.sort(function(t,a){return t[e]-a[e]});var t=this._medianPoint(),a=this._data.slice(0,t),i=this._data.slice(t);return[a,i]}},{key:"average",value:function(){var e=0,t=0,a=0,i=void 0;for(i=0;i<this._dataLength;i+=1)e+=this._data[i][0],t+=this._data[i][1],a+=this._data[i][2];return e/=this._dataLength,t/=this._dataLength,a/=this._dataLength,[parseInt(e,10),parseInt(t,10),parseInt(a,10)]}},{key:"size",value:function(){return this._dataLength}},{key:"_calculateMinMaxAxis",value:function(){var e=1;for(this._axisMinMax=[{min:this._data[0][0],max:this._data[0][0]},{min:this._data[0][1],max:this._data[0][1]},{min:this._data[0][2],max:this._data[0][2]}];e<this._dataLength;e+=1)this._axisMinMax[0].min=this._data[e][0]<this._axisMinMax[0].min?this._data[e][0]:this._axisMinMax[0].min,this._axisMinMax[1].min=this._data[e][1]<this._axisMinMax[1].min?this._data[e][1]:this._axisMinMax[1].min,this._axisMinMax[2].min=this._data[e][2]<this._axisMinMax[2].min?this._data[e][2]:this._axisMinMax[2].min,this._axisMinMax[0].max=this._data[e][0]>this._axisMinMax[0].max?this._data[e][0]:this._axisMinMax[0].max,this._axisMinMax[1].max=this._data[e][1]>this._axisMinMax[1].max?this._data[e][1]:this._axisMinMax[1].max,this._axisMinMax[2].max=this._data[e][2]>this._axisMinMax[2].max?this._data[e][2]:this._axisMinMax[2].max}},{key:"_medianPoint",value:function(){var e=this._getLargestAxis(),t=0,a=0,i=void 0,n=Number.MAX_VALUE,r=void 0;for(r=0;r<this._dataLength;r+=1)a+=this._data[r][e];for(a/=this._dataLength,r=0;r<this._dataLength;r+=1)i=Math.abs(this._data[r][e]-a),i<=n&&(t=r,n=i);return t}},{key:"_getLargestAxis",value:function(){for(var e=0,t=0,a=void 0,i=0,n=this._axisMinMax.length;i<n;i+=1)a=this._axisMinMax[i].max-this._axisMinMax[i].min,a>=t&&(e=i,t=a);return e}}]),e}();t.default=n,e.exports=t.default}])});